<!DOCTYPE html>
<html lang=" en">

<head>
  <base href="/">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
  <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>加解密 | centixkadon</title>
<meta name="generator" content="Jekyll v4.2.0" />
<meta property="og:title" content="加解密" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Twenty four, student." />
<meta property="og:description" content="Twenty four, student." />
<meta property="og:site_name" content="centixkadon" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-04-10T02:03:53+08:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="加解密" />
<script type="application/ld+json">
{"mainEntityOfPage":{"@type":"WebPage","@id":"/t/crypt/"},"url":"/t/crypt/","description":"Twenty four, student.","@type":"BlogPosting","headline":"加解密","dateModified":"2021-04-10T02:03:53+08:00","datePublished":"2021-04-10T02:03:53+08:00","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.min.css" integrity="sha384-+SaL1xc9boZlGbUEAl92ACLIk5BlfrVnmWPv7eP6F06LCqdArNVrEzSMlf648EkB" crossorigin>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js" integrity="sha384-tsQFqpEReu7ZLhBV2VZlAu7zcOV+rXbYlF2cqB8txI/8aZajjp4Bqd+V6D5IgvKT" crossorigin></script>
  
  <link rel="stylesheet" href="css/main.css">
</head>

<body>
  <nav class="navbar navbar-expand-sm navbar-light bg-light sticky-top">
    <div class="container">
      <a class="navbar-brand" href="/">C</a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapse">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbar-collapse">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link" href="/posts/">Posts</a>
          </li>
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/tools/">Tools</a>
          </li>
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/about/">About</a>
          </li>
          
          
          
          
        </ul>
      </div>
    </div>
  </nav>
  <main>
    <div class="container-fluid">
      
<div id="app">
  <div class="row my-3">
    <div class="col">
      <div class="input-group">
        <div class="input-group-prepend">
          <span class="input-group-text">password</span>
        </div>
        <input type="password" class="form-control" v-model="password">
        <div class="input-group-append">
          <span class="input-group-text" v-if="passwordStatusMessage !== null">{{ passwordStatusMessage }}</span>
          <button class="btn btn-secondary text-white" v-bind:class="{ 'btn-success': !encrypt, 'btn-danger': encrypt }" v-on:click="toggleCrypt">{{ cryptMessage }}</button>
        </div>
      </div>
    </div>
  </div>
  <div class="row my-3">
    <div class="col">
      <div class="input-group">
        <textarea class="form-control" rows="20" v-model="input"></textarea>
      </div>
    </div>
    <div class="col">
      <div class="input-group">
        <textarea class="form-control" rows="20" v-model="output"></textarea>
      </div>
    </div>
  </div>
</div>

    </div>
  </main>
  <footer>
    <div class="container-fluid">
      <div class="row">
        <div class="col d-flex">
          <div class="mr-auto mt-auto mb-3">© 2021 centixkadon</div>
        </div>
        <div class="col-1">
          <div class="py-3"></div>
          <div class="py-3"></div>
        </div>
      </div>
    </div>
  </footer>
  
  <footer class="fixed-bottom pointer-events-none">
    <div class="container-fluid">
      <div class="row">
        <div class="col-1">
          <div class="py-3"></div>
          <div class="py-3"></div>
        </div>
        <div class="col d-flex">
          <div class="ml-auto mt-auto mb-3">
            <button class="btn btn-outline-secondary rounded-circle bi-arrow-up pointer-events-all" v-on:click="scrollTop"></button>
          </div>
        </div>
      </div>
    </div>
  </footer>
  

  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-6khuMg9gaYr5AxOqhkVIODVIvm9ynTT5J4V1cfthmT+emCG6yVmEZsRHdxlotUnm" crossorigin></script>
  <script src="https://cdn.jsdelivr.net/npm/vue@2.5.17/dist/vue.min.js" integrity="sha384-9MzmvphdUvLZJKasjD7VqYE4SqffhZDOwDTMyokP2tx+fjBo59ljvrlgUAaaME44" crossorigin></script>
  
  
<script>
  $(function () {
    $('main').addClass("mx-sm-3 mx-md-4 mx-lg-5");
    $('main h1, main .h1').addClass("mt-4 mt-lg-5 mb-4");
    $('main h2, main .h2').addClass("mt-4 mt-lg-5 mb-4");
    $('main h3, main .h3').addClass("mt-4 mb-4");
    $('main h4, main .h4').addClass("mt-4 mb-4");
    $('main blockquote').addClass("blockquote alert alert-primary");
    $('main blockquote p').addClass("mb-0");
    $('main blockquote footer').addClass("blockquote-footer text-right");

    const locks = {};

    Vue.mixin({
      methods: {
        random() {
          const b = Math.pow(0.5, 32);
          const array = crypto.getRandomValues(new Uint32Array(4));
          return Array.from(array).reduce((n, x) => (n + x) * b, 0);
        },

        // code
        arrayFromString(string) {
          return new TextEncoder().encode(string);
        },
        arrayToString(array) {
          return new TextDecoder().decode(array);
        },
        hexFromString(string) {
          return new Uint8Array(string.match(/[\da-fA-F]{1,2}/g).map(x => parseInt(x, 16)));
        },
        hexToString(array) {
          return Array.from(array).map(x => x.toString(16).padStart(2, '0')).join('');
        },
        base64FromString(string) {
          return Uint8Array.from(atob(string), c => c.charCodeAt(0));
        },
        base64ToString(array) {
          return btoa(String.fromCharCode(...new Uint8Array(array)));
        },
        base64urlFromString(string) {
          return this.base64FromString(string.replace(/-/g, "+").replace(/_/g, "/"));
        },
        base64urlToString(array) {
          return this.base64ToString(array).replace(/\+/g, "-").replace(/\//g, "_").replace("=", "");
        },
        base64Encode(string) {
          return this.base64ToString(this.arrayFromString(string));
        },
        base64Decode(string) {
          return this.arrayToString(this.base64FromString(string));
        },

        // digest
        async digest(message, algorithm) {
          return new Uint8Array(await crypto.subtle.digest(algorithm, this.arrayFromString(message)));
        },
        async sha1(message) {
          return await this.digest(message, "SHA-1");
        },
        async sha256(message) {
          return await this.digest(message, "SHA-256");
        },
        async sha384(message) {
          return await this.digest(message, "SHA-384");
        },
        async sha512(message) {
          return await this.digest(message, "SHA-512");
        },

        // crypt
        async aesGcmKey(password) {
          const hashArray = (await this.sha512(password)).slice(0, 32);
          const jwk = {
            k: this.base64urlToString(hashArray),
            kty: ""
          };
          return await crypto.subtle.importKey("jwk", jwk, { name: "AES-GCM" }, true, ["encrypt", "decrypt"]);
        },
        async aesGcmEncrypt(message, password) {
          const ivArray = crypto.getRandomValues(new Uint8Array(12));
          const algorithm = { name: "AES-GCM", iv: ivArray };
          const key = await this.aesGcmKey(password);
          const decryptArray = this.arrayFromString(message);
          const encryptArray = await crypto.subtle.encrypt(algorithm, key, decryptArray);
          return {
            data: this.base64ToString(encryptArray),
            iv: this.hexToString(ivArray)
          };
        },
        async aesGcmDecrypt({ data: data, iv: iv }, password) {
          const ivArray = this.hexFromString(iv);
          const algorithm = { name: "AES-GCM", iv: ivArray };
          const key = await this.aesGcmKey(password);
          const encryptArray = this.base64FromString(data);
          const decryptArray = await crypto.subtle.decrypt(algorithm, key, encryptArray);
          return this.arrayToString(decryptArray);
        },

        // lock
        lock(key, func) {
          if (!locks[key]) {
            locks[key] = true;
            func.apply(this);
            vm.$nextTick(() => {
              locks[key] = false;
            });
          }
        },
        async alock(key, afunc) {
          if (!locks[key]) {
            locks[key] = true;
            await afunc.apply(this);
            vm.$nextTick(() => {
              locks[key] = false;
            });
          }
        },

        // load, store
        load(key, defaultJson) {
          defaultJson = defaultJson || "{}";
          return JSON.parse(localStorage.getItem(key) || defaultJson);
        },
        store(key, json) {
          if (json == undefined) {
            localStorage.removeItem(key);
          } else {
            localStorage.setItem(key, JSON.stringify(json));
          }
        },
      }
    });

    new Vue({
      el: "footer.fixed-bottom",
      data: {
        scroll: true,
      },
      methods: {
        scrollTop() {
          const vm = this;
          if (vm.scroll) {
            for (const selector of ['html', 'body']) {
              if ($(selector).scrollTop() !== 0) {
                vm.scroll = false;
                $(selector).animate({ scrollTop: 0 }, function () {
                  vm.scroll = true;
                });
              }
            }
          }
        }
      },
    })

  });
</script>

  
  <script>
  $(() => {
    const storageKey = "tool_crypt";
    const inputLock = Symbol("lock inputs");

    window.vm = new Vue({
      el: "#app",

      data: {
        encrypt: false,
        password: "",
        password_status: false,
        input: "",
        output: "",
        locked: true,
      },
      created() {
        this.output = JSON.stringify(this.load(storageKey).output) || "";
      },

      watch: {
        password() {
          this.alock(inputLock, async () => {
            if (this.encrypt) {
              await this.encryptText();
            } else {
              await this.decryptText();
            }
          });
        },
        input() {
          this.alock(inputLock, async () => {
            await this.encryptText();
            this.encrypt = true;
          });
        },
        output() {
          this.alock(inputLock, async () => {
            await this.decryptText();
            this.encrypt = false;
          });
        },
      },

      computed: {
        passwordStatusMessage() {
          if (!this.encrypt && this.password) {
            return this.password_status ? "✔" : "❌";
          } else {
            return null;
          }
        },

        cryptMessage() {
          return this.encrypt ? "encrypt" : "decrypt";
        },
      },

      methods: {
        toggleCrypt() {
          this.encrypt = !this.encrypt;
        },

        async encryptText() {
          if (this.input && this.password) {
            const decrypt = JSON.stringify({
              input: this.input,
              hash: await this.hash(this.input)
            });
            const encrypt = await this.aesGcmEncrypt(decrypt, this.password);
            this.output = JSON.stringify(encrypt);

            this.store(storageKey, { output: encrypt });
          }
        },

        async decryptText() {
          if (this.output && this.password) {
            try {
              const encrypt = JSON.parse(this.output);
              const decrypt = JSON.parse(await this.aesGcmDecrypt(encrypt, this.password));
              console.log("decrypt", decrypt);
              if (decrypt.input && decrypt.hash && decrypt.hash === await this.hash(decrypt.input)) {
                this.input = decrypt.input;
                this.password_status = true;

                this.store(storageKey, { output: encrypt });
                return;
              }
            } catch (error) { }
            this.password_status = false;
          }
        },

        async hash(message) {
          return this.hexToString(await this.sha1(message));
        },

      },
    });

  });
</script>
  
</body>

</html>